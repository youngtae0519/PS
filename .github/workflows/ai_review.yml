name: Algorithm Code Review

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare Code and Fetch Problem Info
        id: prepare
        run: |
          git config core.quotepath false
          FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '\.py' || true)
          
          if [ -z "$FILES" ]; then
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
          echo "review_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          FIRST_FILE=$(echo $FILES | awk '{print $1}')
          PROBLEM_INFO=$(basename "$(dirname "$FIRST_FILE")")
          echo "title_info=$PROBLEM_INFO" >> $GITHUB_OUTPUT

          # ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: 15552. ë¹ ë¥¸ A+B -> 15552)
          PROBLEM_NO=$(echo $PROBLEM_INFO | cut -d'.' -f1 | tr -d ' ')
          echo "prob_no=$PROBLEM_NO" >> $GITHUB_OUTPUT

          # 1. solved.ac API í˜¸ì¶œ (ë‚œì´ë„ ë° íƒœê·¸)
          RESPONSE=$(curl -s "https://solved.ac/api/v3/problem/show?problemId=$PROBLEM_NO")
          LEVEL=$(echo $RESPONSE | jq -r '.level')
          TAGS=$(echo $RESPONSE | jq -r '.tags[].displayNames[] | select(.language=="ko") | .name' | tr '\n' ',' | sed 's/,$//')
          
          echo "prob_level=$LEVEL" >> $GITHUB_OUTPUT
          echo "algo_tags=$TAGS" >> $GITHUB_OUTPUT

          # 2. ì½”ë“œ ë° í”„ë¡¬í”„íŠ¸ íŒŒì¼ ì €ì¥
          echo "### ì œì¶œí•œ ì½”ë“œ ë‚´ìš© ###" > submitted_code.txt
          for file in $FILES; do
            echo -e "\n--- FILE: $file ---\n" >> submitted_code.txt
            cat "$file" >> submitted_code.txt
          done

          echo "ë„ˆëŠ” ë°±ì¤€ ì „ë¬¸ê°€ì´ì íŒŒì´ì¬ ë§ˆìŠ¤í„°ì•¼. ì•„ë˜ [ì½”ë“œ]ë¥¼ ë¦¬ë·°í•´ì¤˜." > full_prompt.txt
          echo -e "\n[ì½”ë“œ]\n" >> full_prompt.txt
          cat submitted_code.txt >> full_prompt.txt
          echo -e "\n[ë¦¬ë·° ë¯¸ì…˜]\n0. ë¬¸ì œ ìš”ì•½\n1. ì•Œê³ ë¦¬ì¦˜ ë¶„ë¥˜ ë° ì œí•œ ì‚¬í•­\n2. íš¨ìœ¨ì„± ë¶„ì„ ë° TLE ê°€ëŠ¥ì„±\n3. ê°œì„ ì•ˆ\n4. ë°˜ë¡€\në‹µë³€ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì¤˜." >> full_prompt.txt
          
          echo "has_files=true" >> $GITHUB_OUTPUT

      - name: AI Review
        if: steps.prepare.outputs.has_files == 'true'
        run: |
          npm install -g @google/gemini-cli
          gemini --gemini_api_key "${{ secrets.GEMINI_API_KEY }}" \
                 --gemini_model "gemini-2.5-flash" \
                 --prompt "$(cat full_prompt.txt)" > review_result.txt

      - name: Create Issue with Colors and Template
        if: steps.prepare.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const code = fs.readFileSync('submitted_code.txt', 'utf8');
            const review = fs.readFileSync('review_result.txt', 'utf8');
            
            // 3. ë‚œì´ë„ë³„ ê³µì‹ ìƒ‰ìƒ ì„¤ì • (Hex)
            const tierColors = {
              "Bronze": "ad5600",
              "Silver": "435f7a",
              "Gold": "ec9a00",
              "Platinum": "27e2a4",
              "Diamond": "00b4fc",
              "Ruby": "ff0062",
              "Unrated": "2d2d2d"
            };

            const getTierInfo = (level) => {
              if (level === 0) return { name: "Unrated", color: tierColors["Unrated"] };
              const tiers = ["Bronze", "Silver", "Gold", "Platinum", "Diamond", "Ruby"];
              const roman = ["V", "IV", "III", "II", "I"];
              const tierIdx = Math.floor((level - 1) / 5);
              const rankIdx = (level - 1) % 5;
              return { 
                name: `${tiers[tierIdx]} ${roman[4 - rankIdx]}`, 
                color: tierColors[tiers[tierIdx]] 
              };
            };

            const tier = getTierInfo(parseInt("${{ steps.prepare.outputs.prob_level }}"));
            
            // ë¼ë²¨ ìƒì„±/í™•ì¸ í•¨ìˆ˜
            const ensureLabel = async (name, color) => {
              try {
                await github.rest.issues.getLabel({ owner: context.repo.owner, repo: context.repo.repo, name: name });
              } catch (e) {
                await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, name: name, color: color });
              }
            };

            await ensureLabel(tier.name, tier.color);
            await ensureLabel('code-review', '1d76db');

            const algoTags = "${{ steps.prepare.outputs.algo_tags }}".split(',').filter(t => t);
            for (const tag of algoTags) { await ensureLabel(tag, 'ededed'); }

            // 4. ì´ìŠˆ ìƒì„±
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${{ steps.prepare.outputs.review_date }}] AI ë¦¬ë·°: ${{ steps.prepare.outputs.title_info }}`,
              body: `## ğŸ“ ì œì¶œ ì½”ë“œ\n\n\`\`\`python\n${code}\n\`\`\`\n\n---\n\n## ğŸ¤– AI ë¶„ì„ ê²°ê³¼\n**ë‚œì´ë„:** ${tier.name}\n**ë§í¬:** https://www.acmicpc.net/problem/${{ steps.prepare.outputs.prob_no }}\n\n${review}`,
              labels: [tier.name, ...algoTags, 'code-review']
            });

            // 5. ë³µê¸° ëŒ“ê¸€ í…œí”Œë¦¿ ë‹¬ê¸°
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `### âœï¸ ì˜¤ëŠ˜ì˜ ë³µê¸° ê¸°ë¡\n\n**1. í•µì‹¬ ë¡œì§**\n- \n\n**2. ì‹œí–‰ì°©ì˜¤**\n- \n\n**3. ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ íŒ**\n-  `
            });
