name: Algorithm Code Review

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare Code and Fetch Problem Info
        id: prepare
        run: |
          git config core.quotepath false
          FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '\.py' || true)
          
          if [ -z "$FILES" ]; then
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "review_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          FIRST_FILE=$(echo $FILES | awk '{print $1}')
          PROBLEM_INFO=$(basename "$(dirname "$FIRST_FILE")")
          echo "title_info=$PROBLEM_INFO" >> $GITHUB_OUTPUT
          PROBLEM_NO=$(echo $PROBLEM_INFO | cut -d'.' -f1 | tr -d ' ')
          echo "prob_no=$PROBLEM_NO" >> $GITHUB_OUTPUT

          RESPONSE=$(curl -s "https://solved.ac/api/v3/problem/show?problemId=$PROBLEM_NO")
          echo "prob_level=$(echo $RESPONSE | jq -r '.level')" >> $GITHUB_OUTPUT
          echo "algo_tags=$(echo $RESPONSE | jq -r '.tags[].displayNames[] | select(.language=="ko") | .name' | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

          echo "### ì œì¶œ ì½”ë“œ ###" > submitted_code.txt
          cat "$FIRST_FILE" >> submitted_code.txt

          # 1. í•µì‹¬ ìœ„ì£¼, ê°œì„ ì  ì§‘ì¤‘, ê°œì¡°ì‹ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
          cat <<EOF > full_prompt.txt
          ë„ˆëŠ” ì•Œê³ ë¦¬ì¦˜ íš¨ìœ¨ì„±ê³¼ íŒŒì´ì¬ ì„±ëŠ¥ ìµœì í™”ì˜ ëŒ€ê°€ì•¼. 
          ì œê³µëœ [ì½”ë“œ]ë¥¼ ë¶„ì„í•˜ê³ , ë‹¤ìŒ ì§€ì¹¨ì— ë”°ë¼ ë¦¬ë·°ë¥¼ ì‘ì„±í•´.
          
          [ì‘ì„± ì›ì¹™]
          - ëª¨ë“  ë¶„ì„ì€ í•µì‹¬ ìœ„ì£¼ë¡œ ì•„ì£¼ ê°„ê²°í•˜ê²Œ ì‘ì„±í•  ê²ƒ.
          - ì„œìˆ í˜• ë¬¸ì¥ì„ ì§€ì–‘í•˜ê³ , ë°˜ë“œì‹œ ê°œì¡°ì‹(Bullet point)ì„ ì‚¬ìš©í•  ê²ƒ.
          - ì´ë¯¸ íš¨ìœ¨ì ì¸ ë¶€ë¶„ì— ëŒ€í•œ ì¹­ì°¬ì´ë‚˜ ë¶ˆí•„ìš”í•œ ë¯¸ì‚¬ì—¬êµ¬ëŠ” ì ˆëŒ€ ìƒëµí•  ê²ƒ.
          - ì˜¤ì§ 'ê°œì„ í•  ì 'ê³¼ 'ì ì¬ì  ìœ„í—˜'ì—ë§Œ ì§‘ì¤‘í•  ê²ƒ.
          
          [ë¦¬ë·° ë¯¸ì…˜]
          0. **ë¬¸ì œ ìš”ì•½**: í•µì‹¬ ìš”êµ¬ì‚¬í•­ê³¼ Nì˜ ë²”ìœ„ë¥¼ í•œ ì¤„ë¡œ ìš”ì•½.
          1. **ë¶„ì„**: $O(N)$ ë³µì¡ë„ ì§„ë‹¨ ë° ì‹œê°„/ë©”ëª¨ë¦¬ ì œí•œ ì¶©ì¡± ì—¬ë¶€ (ë¶ˆë › í¬ì¸íŠ¸).
          2. **ê°œì„ í•  ì **: 
             - ì„±ëŠ¥ ë³‘ëª© ì§€ì  ë° ë©”ëª¨ë¦¬ ë‚­ë¹„ ìš”ì†Œ ì§€ì .
             - ë” íš¨ìœ¨ì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬(heapq, deque ë“±) ë° ìµœì í™” ê¸°ë²• ì œì•ˆ.
          3. **ë°˜ë¡€ (Edge Case)**: ì½”ë“œê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆëŠ” ê²½ê³„ê°’ì´ë‚˜ íŠ¹ìˆ˜ ìƒí™© ì œì‹œ.
          
          ë‹µë³€ì€ í•œêµ­ì–´ë¡œ "ë¬¸ì œ ìš”ì•½ - ë¶„ì„ - ê°œì„ ì•ˆ - ë°˜ë¡€" ìˆœì„œë¡œ ì‘ì„±í•´.
          [ì½”ë“œ]
          $(cat submitted_code.txt)
          EOF
          echo "has_files=true" >> $GITHUB_OUTPUT

      - name: AI Review
        if: steps.prepare.outputs.has_files == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          npm install -g @google/gemini-cli
          # 2. ëª¨ë¸ì„ gemini-2.5-flashë¡œ ì—…ë°ì´íŠ¸
          gemini --model "gemini-2.5-flash" \
                 --prompt "$(cat full_prompt.txt)" > review_result.txt

      - name: Create Issue
        if: steps.prepare.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const code = fs.readFileSync('submitted_code.txt', 'utf8');
            const review = fs.readFileSync('review_result.txt', 'utf8');
            
            const tierColors = {
              "Bronze": "ad5600", "Silver": "435f7a", "Gold": "ec9a00",
              "Platinum": "27e2a4", "Diamond": "00b4fc", "Ruby": "ff0062", "Unrated": "2d2d2d"
            };

            const getTierInfo = (level) => {
              const tiers = ["Bronze", "Silver", "Gold", "Platinum", "Diamond", "Ruby"];
              const roman = ["V", "IV", "III", "II", "I"];
              
              if (level === 0 || isNaN(level)) return { name: "Unrated", color: tierColors["Unrated"] };
              
              const tierIndex = Math.floor((level - 1) / 5);
              const romanIndex = (level - 1) % 5; // 4ì—ì„œ ëº„ í•„ìš” ì—†ì´ ê·¸ëŒ€ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš©
              
              return { 
                name: `${tiers[tierIndex]} ${roman[romanIndex]}`, 
                color: tierColors[tiers[tierIndex]] 
              };
            };

            const tier = getTierInfo(parseInt("${{ steps.prepare.outputs.prob_level }}"));
            const ensureLabel = async (name, color) => {
              try { await github.rest.issues.getLabel({ owner: context.repo.owner, repo: context.repo.repo, name: name }); }
              catch (e) { await github.rest.issues.createLabel({ owner: context.repo.owner, repo: context.repo.repo, name: name, color: color }); }
            };

            await ensureLabel(tier.name, tier.color);
            await ensureLabel('code-review', '1d76db');
            const algoTags = "${{ steps.prepare.outputs.algo_tags }}".split(',').filter(t => t);
            for (const tag of algoTags) { await ensureLabel(tag, 'ededed'); }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner, repo: context.repo.repo,
              title: `[${{ steps.prepare.outputs.review_date }}] AI ë¦¬ë·°: ${{ steps.prepare.outputs.title_info }}`,
              body: `## ğŸ“ ì œì¶œ ì½”ë“œ\n\n\`\`\`python\n${code}\n\`\`\`\n\n---\n\n## ğŸ¤– AI ë¶„ì„ ê²°ê³¼\n**ë‚œì´ë„:** ${tier.name} | **ë§í¬:** https://www.acmicpc.net/problem/${{ steps.prepare.outputs.prob_no }}\n\n${review}`,
              labels: [tier.name, ...algoTags, 'code-review']
            });

            // 3. ëŒ“ê¸€ í…œí”Œë¦¿ ìˆ˜ì • (ë‹¤ì§ ì œê±°)
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.data.number,
              body: "### âœï¸ ì˜¤ëŠ˜ì˜ ë³µê¸° ê¸°ë¡\n\n**1. í•µì‹¬ ë¡œì§**\n- \n\n**2. ì‹œí–‰ì°©ì˜¤**\n- \n\n**3. ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ íŒ**\n- "
            });
