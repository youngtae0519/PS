name: Algorithm Code Review

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare Code Content
        id: prepare
        run: |
          git config core.quotepath false
          FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '\.py' || true)
          
          if [ -z "$FILES" ]; then
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 1. ì˜¤ëŠ˜ ë‚ ì§œ ìƒì„±
          echo "review_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

          # 2. ë°±ì¤€í—ˆë¸Œ í´ë”ëª…ì—ì„œ ë¬¸ì œ ì •ë³´ ì¶”ì¶œ (ì˜ˆ: 10869. ì‚¬ì¹™ì—°ì‚°)
          FIRST_FILE=$(echo $FILES | awk '{print $1}')
          DIR_NAME=$(dirname "$FIRST_FILE")
          PROBLEM_INFO=$(basename "$DIR_NAME")
          echo "title_info=$PROBLEM_INFO" >> $GITHUB_OUTPUT

          # ì½”ë“œ ë‚´ìš© ë³‘í•©
          echo "CODE_DATA<<EOF" > code_content.txt
          for file in $FILES; do
            echo "### FILE_PATH: $file ###" >> code_content.txt
            cat "$file" >> code_content.txt
            echo -e "\n" >> code_content.txt
          done
          echo "EOF" >> code_content.txt

          cat code_content.txt >> $GITHUB_OUTPUT
          echo "has_files=true" >> $GITHUB_OUTPUT

      - name: AI Review
        if: steps.prepare.outputs.has_files == 'true'
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: "gemini-1.5-flash" # ì†ë„ì™€ ì•ˆì •ì„±ì„ ìœ„í•´ Flash ëª¨ë¸ ì‚¬ìš©
          prompt: |
            ë„ˆëŠ” ë°±ì¤€ ì•Œê³ ë¦¬ì¦˜ ì „ë¬¸ê°€ì´ì íŒŒì´ì¬ ë§ˆìŠ¤í„°ì•¼. ì•„ë˜ [ì½”ë“œ]ë¥¼ ë¦¬ë·°í•´ì¤˜.
            íŒŒì¼ ê²½ë¡œì— ìˆëŠ” ìˆ«ìê°€ ë°±ì¤€ ë¬¸ì œ ë²ˆí˜¸ì•¼.

            [ì½”ë“œ]
            ${{ steps.prepare.outputs.CODE_DATA }}

            [ë¦¬ë·° ë¯¸ì…˜]
            1. ë¬¸ì œ ë²ˆí˜¸ì— ë”°ë¥¸ 'ì•Œê³ ë¦¬ì¦˜ ë¶„ë¥˜'ì™€ 'ì‹œê°„/ë©”ëª¨ë¦¬ ì œí•œ' ì–¸ê¸‰.
            2. í˜„ì¬ ì½”ë“œì˜ ì•Œê³ ë¦¬ì¦˜ íš¨ìœ¨ì„± ë¶„ì„ ë° ì‹œê°„ ì´ˆê³¼ ê°€ëŠ¥ì„± ê²€í† .
            3. ë” íš¨ìœ¨ì ì´ê±°ë‚˜ Pythonicí•œ ê°œì„ ì•ˆ ì œì•ˆ.
            4. ë†“ì¹˜ê¸° ì‰¬ìš´ ë°˜ë¡€(Edge Case) ì œì‹œ.

            ë‹µë³€ì€ í•œêµ­ì–´ë¡œ "ì´í‰ - ë¶„ì„ - ê°œì„ ì•ˆ - ë°˜ë¡€" ìˆœì„œë¡œ ê°€ë…ì„± ìˆê²Œ ì‘ì„±í•´ì¤˜.

      - name: Create Issue
        if: steps.prepare.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.gemini.outputs.text }}`;
            const date = "${{ steps.prepare.outputs.review_date }}";
            const problem = "${{ steps.prepare.outputs.title_info }}";
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${date}] AI ë¦¬ë·°: ${problem}`,
              body: "## ğŸ¤– Gemini ì•Œê³ ë¦¬ì¦˜ ë¶„ì„ ê²°ê³¼\n\n" + review,
              labels: ['code-review', 'algorithm']
            });
