name: Algorithm Code Review

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare Basic Info
        id: prepare
        run: |
          git config core.quotepath false
          FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '\.py' || true)
          
          if [ -z "$FILES" ]; then
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "review_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          FIRST_FILE=$(echo $FILES | awk '{print $1}')
          PROBLEM_INFO=$(basename "$(dirname "$FIRST_FILE")")
          echo "title_info=$PROBLEM_INFO" >> $GITHUB_OUTPUT
          
          # ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: "1000.A+B" -> "1000")
          PROBLEM_NO=$(echo $PROBLEM_INFO | cut -d'.' -f1 | tr -d ' ')
          echo "prob_no=$PROBLEM_NO" >> $GITHUB_OUTPUT

          # Solved.ac API í˜¸ì¶œ (ë‚œì´ë„ ë° íƒœê·¸ ì •ë³´)
          RESPONSE=$(curl -s "https://solved.ac/api/v3/problem/show?problemId=$PROBLEM_NO")
          PROB_LEVEL=$(echo $RESPONSE | jq -r '.level')
          ALGO_TAGS=$(echo $RESPONSE | jq -r '.tags[].displayNames[] | select(.language=="ko") | .name' | tr '\n' ',' | sed 's/,$//')
          
          echo "prob_level=$PROB_LEVEL" >> $GITHUB_OUTPUT
          echo "algo_tags=$ALGO_TAGS" >> $GITHUB_OUTPUT
          echo "first_file=$FIRST_FILE" >> $GITHUB_OUTPUT
          echo "has_files=true" >> $GITHUB_OUTPUT

      - name: Fetch Problem Constraints (Crawling)
        if: steps.prepare.outputs.has_files == 'true'
        id: crawl
        run: |
          pip install requests beautifulsoup4
          
          python3 - <<EOF > problem_details.txt
          import requests
          from bs4 import BeautifulSoup
          import os

          prob_no = "${{ steps.prepare.outputs.prob_no }}"
          url = f"https://www.acmicpc.net/problem/{prob_no}"
          headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}
          
          try:
              res = requests.get(url, headers=headers)
              soup = BeautifulSoup(res.text, 'html.parser')
              
              # ì‹œê°„/ë©”ëª¨ë¦¬ ì œí•œ í…Œì´ë¸” ì¶”ì¶œ
              info_table = soup.select('#problem-info tr td')
              time_limit = info_table[0].text.strip()
              mem_limit = info_table[1].text.strip()
              
              # ì…ë ¥ ì œì•½ ì‚¬í•­ í…ìŠ¤íŠ¸ ì¶”ì¶œ
              input_section = soup.select_one('#problem_input').text.strip()
              
              print(f"### ì‹¤ì œ ë¬¸ì œ ì œì•½ ì¡°ê±´ ###")
              print(f"- ì‹œê°„ ì œí•œ: {time_limit}")
              print(f"- ë©”ëª¨ë¦¬ ì œí•œ: {mem_limit}")
              print(f"- ì…ë ¥ ì„¤ëª… ë° ë²”ìœ„:\n{input_section}")
          except Exception as e:
              print(f"ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {e}")
          EOF

      - name: Generate AI Prompt
        if: steps.prepare.outputs.has_files == 'true'
        run: |
          PROBLEM_NO="${{ steps.prepare.outputs.prob_no }}"
          ALGO_TAGS="${{ steps.prepare.outputs.algo_tags }}"
          FIRST_FILE="${{ steps.prepare.outputs.first_file }}"
          
          cat <<EOF > full_prompt.txt
          ë„ˆëŠ” ì•Œê³ ë¦¬ì¦˜ íš¨ìœ¨ì„±ê³¼ íŒŒì´ì¬ ì„±ëŠ¥ ìµœì í™”ì˜ ëŒ€ê°€ì•¼. 
          í˜„ì¬ ë¶„ì„ ì¤‘ì¸ ë¬¸ì œëŠ” ë°±ì¤€ ${PROBLEM_NO}ë²ˆì´ë©°, ì•Œê³ ë¦¬ì¦˜ ë¶„ë¥˜ëŠ” [${ALGO_TAGS}]ì•¼.

          $(cat problem_details.txt)

          [ì‘ì„± ì›ì¹™]
          - ë°˜ë“œì‹œ ìœ„ì—ì„œ ì œê³µëœ **ì‹¤ì œ ì œì•½ ì¡°ê±´(N, M ë²”ìœ„, ì‹œê°„ ì œí•œ ë“±)**ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•  ê²ƒ.
          - ëª¨ë“  ë¶„ì„ì€ í•µì‹¬ ìœ„ì£¼ë¡œ ì•„ì£¼ ê°„ê²°í•˜ê²Œ ì‘ì„±í•  ê²ƒ.
          - ë°˜ë“œì‹œ ê°œì¡°ì‹(Bullet point)ì„ ì‚¬ìš©í•  ê²ƒ.
          - ì¹­ì°¬ì€ ìƒëµí•˜ê³ , 'ê°œì„ í•  ì 'ê³¼ 'ì ì¬ì  ìœ„í—˜'ì—ë§Œ ì§‘ì¤‘í•  ê²ƒ.

          [ë¦¬ë·° ë¯¸ì…˜]
          0. **ë¬¸ì œ ìš”ì•½**: í•µì‹¬ ìš”êµ¬ì‚¬í•­ê³¼ ì œì•½ ì¡°ê±´ì„ í•œ ì¤„ ìš”ì•½.
          1. **ë¶„ì„**: ì‹¤ì œ ì œí•œ ëŒ€ë¹„ í˜„ì¬ ì½”ë“œì˜ ì‹œê°„/ê³µê°„ ë³µì¡ë„($O$ í‘œê¸°ë²• ì‚¬ìš©) ì§„ë‹¨.
          2. **ê°œì„ í•  ì **: ì„±ëŠ¥ ë³‘ëª© ì§€ì  ì§€ì  ë° íŒŒì´ì¬ íŠ¹í™” ìµœì í™” ê¸°ë²• ì œì•ˆ.
          3. **ë°˜ë¡€ (Edge Case)**: ì½”ë“œê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆëŠ” ê²½ê³„ê°’ì´ë‚˜ íŠ¹ìˆ˜ ìƒí™© ì œì‹œ.

          ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•´.

          [ì œì¶œëœ ì½”ë“œ]
          $(cat $FIRST_FILE)
          EOF

      - name: AI Review
        if: steps.prepare.outputs.has_files == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          npm install -g @google/gemini-cli
          gemini --model "gemini-2.5-flash" \
                 --prompt "$(cat full_prompt.txt)" > review_result.txt

      - name: Create Issue
        if: steps.prepare.outputs.has_files == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const code = fs.readFileSync("${{ steps.prepare.outputs.first_file }}", 'utf8');
            const review = fs.readFileSync('review_result.txt', 'utf8');
            
            const tierColors = {
              "Bronze": "ad5600", "Silver": "435f7a", "Gold": "ec9a00",
              "Platinum": "27e2a4", "Diamond": "00b4fc", "Ruby": "ff0062", "Unrated": "2d2d2d"
            };

            const getTierInfo = (level) => {
              const tiers = ["Bronze", "Silver", "Gold", "Platinum", "Diamond", "Ruby"];
              const roman = ["V", "IV", "III", "II", "I"];
              if (!level || level === 0 || isNaN(level)) return { name: "Unrated", color: tierColors["Unrated"] };
              const tierIndex = Math.floor((level - 1) / 5);
              const romanIndex = (level - 1) % 5;
              return { name: `${tiers[tierIndex]} ${roman[romanIndex]}`, color: tierColors[tiers[tierIndex]] };
            };

            const tier = getTierInfo(parseInt("${{ steps.prepare.outputs.prob_level }}"));
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner, repo: context.repo.repo,
              title: `[${{ steps.prepare.outputs.review_date }}] AI ë¦¬ë·°: ${{ steps.prepare.outputs.title_info }}`,
              body: `## ğŸ“ ì œì¶œ ì½”ë“œ\n\n\`\`\`python\n${code}\n\`\`\`\n\n---\n\n## ğŸ¤– AI ë¶„ì„ ê²°ê³¼\n**ë‚œì´ë„:** ${tier.name} | **ë§í¬:** https://www.acmicpc.net/problem/${{ steps.prepare.outputs.prob_no }}\n\n${review}`,
              labels: [tier.name, 'code-review']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.data.number,
              body: "### âœï¸ ì˜¤ëŠ˜ì˜ ë³µê¸° ê¸°ë¡\n\n**1. í•µì‹¬ ë¡œì§**\n- \n\n**2. ì‹œí–‰ì°©ì˜¤**\n- \n\n**3. ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ íŒ**\n- "
            });
