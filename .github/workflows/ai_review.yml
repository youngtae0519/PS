name: Algorithm Code Review

on:
  push:
    branches:
      - main  # ë°±ì¤€í—ˆë¸Œê°€ í‘¸ì‹œí•˜ëŠ” ë¸Œëœì¹˜ëª… í™•ì¸ (main ë˜ëŠ” master)

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: files
        run: |
          # ìƒˆë¡œ ì¶”ê°€ë˜ê±°ë‚˜ ìˆ˜ì •ëœ .py íŒŒì¼ë§Œ ì¶”ì¶œ
          echo "changed_files=$(git diff --name-only HEAD^ HEAD | grep '\.py' | xargs)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: pip install -q -U google-generativeai

      - name: AI Review using Python
        if: steps.files.outputs.changed_files != ''
        env:
          GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python -c "
          import google.generativeai as genai
          import os

          # 1. Gemini ì„¤ì •
          genai.configure(api_key=os.environ['GOOGLE_API_KEY'])
          model = genai.GenerativeModel('gemini-1.5-flash')

          changed_files = '${{ steps.files.outputs.changed_files }}'.split()
          
          for file_path in changed_files:
              # 2. íŒŒì¼ ë‚´ìš© ì½ê¸°
              with open(file_path, 'r', encoding='utf-8') as f:
                  code = f.read()
              
              # 3. ë¬¸ì œ ë²ˆí˜¸ë¥¼ í¬í•¨í•œ ê³ ë„í™”ëœ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
              prompt = f'''
          ë„ˆëŠ” êµ¬ê¸€ ì½”ë¦¬ì•„ ì¶œì‹ ì˜ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œ í•´ê²°(PS) ì „ë¬¸ê°€ì•¼. 
          ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì œì¶œëœ íŒŒì´ì¬ ì½”ë“œë¥¼ ì—„ê²©í•˜ê²Œ ë¦¬ë·°í•´ì¤˜.

          [ë¬¸ì œ ì •ë³´]
          íŒŒì¼ ê²½ë¡œ: {file_path} 
          (ê²½ë¡œì— í¬í•¨ëœ ë¬¸ì œ ë²ˆí˜¸ì™€ ì œëª©ì„ ì°¸ê³ í•´ì„œ í•´ë‹¹ ë¬¸ì œì˜ ì œì•½ ì¡°ê±´ì„ íŒŒì•…í•´ì¤˜.)

          [ì œì¶œ ì½”ë“œ]
          {code}

          [ë¦¬ë·° ê°€ì´ë“œë¼ì¸]
          1. ì‹œê°„/ê³µê°„ ë³µì¡ë„: ë¬¸ì œì˜ N ë²”ìœ„ì— ë¹„ì¶”ì–´ ìµœì ì¸ê°€? (ì˜ˆ: Nì´ 10ë§Œì´ë©´ O(N log N) ì´í•˜ì¸ì§€ ë“±)
          2. ìµœì í™”: ë” íš¨ìœ¨ì ì¸ ì•Œê³ ë¦¬ì¦˜ì´ë‚˜ ìë£Œêµ¬ì¡°(heapq, deque ë“±) ì œì•ˆì´ í•„ìš”í•œê°€?
          3. Pythonic Code: íŒŒì´ì¬ë‹¤ìš´ ê°„ê²°í•œ ë¬¸ë²•ì„ ì¼ëŠ”ê°€? (List Comprehension, ë‚´ì¥ í•¨ìˆ˜ í™œìš© ë“±)
          4. ê²°í•¨ ê°€ëŠ¥ì„±: ì—£ì§€ ì¼€ì´ìŠ¤(ì…ë ¥ì´ 1ê°œì¼ ë•Œ ë“±)ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì˜¤ë¥˜ê°€ ìˆëŠ”ê°€?

          ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, í•µì‹¬ ìœ„ì£¼ë¡œ ë²ˆí˜¸ë¥¼ ë§¤ê²¨ì„œ ì¹œì ˆí•˜ê²Œ ì‘ì„±í•´ì¤˜.
          '''
              
              # 4. AI ë¦¬ë·° ìƒì„± ë° ì¶œë ¥
              response = model.generate_content(prompt)
              print(f'### ğŸ“ Review for: {file_path}')
              print(response.text)
              print('\n' + '='*50 + '\n')

              # 5. GitHub Action ìš”ì•½ í˜ì´ì§€ì—ë„ ì¶”ê°€
              with open(os.environ['GITHUB_STEP_SUMMARY'], 'a', encoding='utf-8') as summary:
                  summary.write(f'## ğŸ“ {file_path} ë¦¬ë·° ê²°ê³¼\n')
                  summary.write(response.text + '\n\n')
          "
